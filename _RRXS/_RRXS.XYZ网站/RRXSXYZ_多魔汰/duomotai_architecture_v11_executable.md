# 多魔汰架构文档 v11 - 可执行版

**版本**: v11.0 Executable
**创建时间**: 2025-10-09
**核心定位**: 从v8深度优化版到可交付产品的3阶段执行计划
**第一纲领**: 项目高效早日完成

---

## **📋 文档导航**

1. [核心原则与设计理念](#1-核心原则与设计理念)
2. [当前状态评估(v8)](#2-当前状态评估v8)
3. [三阶段交付计划](#3-三阶段交付计划)
4. [架构设计](#4-架构设计)
5. [关键技术决策](#5-关键技术决策)
6. [风险与应对](#6-风险与应对)
7. [验收标准](#7-验收标准)

---

## **1. 核心原则与设计理念**

### **1.1 第一纲领**

**🎯 项目高效早日完成 > 追求完美**

**判断标准:**
- ✅ 是否直接贡献于可交付的功能? → 做
- ❌ 是否增加不必要的复杂度? → 简化或去除
- ✅ 是否可以通过更简单的方式实现? → 优先简单方案

### **1.2 核心需求(用户驱动)**

> "对话的延续性、实际现实符合性、深度递进性最重要,同时需要更友好的界面和交互体验。"

**关键词解析:**
- **延续性**: 专家发言需与自己之前的观点连贯,展现思考的递进
- **实际现实符合性**: 模拟真实会议场景,专家之间有互动、有争议、有回应
- **深度递进性**: 每次发言都应推进讨论深度,避免重复或表面化
- **用户体验**: 界面需清晰美观,交互需流畅,重点内容需突出显示

### **1.3 v11与v10的区别**

**v10问题(理论化过度):**
- 2000+行文档,60%是示例代码
- 包含大量非必需功能(多语言/Redis/审计系统)
- 缺乏明确的里程碑和验收标准

**v11优化(可执行化):**
- ✅ 聚焦核心功能,分3个可交付阶段
- ✅ 每个任务明确工作量(1-8分,1分≈1小时)
- ✅ 每阶段有验收标准和备份要求
- ✅ 去除过度设计,保留精华(ContextDatabase/summaryEngine/Prompt-Agent)

---

## **2. 当前状态评估(v8)**

### **2.1 已完成的核心功能**

**✅ v8深度优化版成果(2025-10-03):**
1. **16角色提示词全面打磨**
   - 新增"建议要求"模块
   - 强制数据化要求(至少1-2个数据引用/案例)
   - 文件: `duomotai/src/config/roles.js` (v8版本)

2. **领袖提示词人性化升级**
   - 开场客套语 + 结束邀请语
   - 文件: `duomotai/src/modules/debateEngine.js` lines 165-220

3. **5阶段交互流程**
   - 准备→策划→确认→辩论→交付
   - 支持策划阶段循环调整

4. **6-5-5角色分组方案**
   - 核心层6个(蓝色 #007AFF)
   - 外部层5个(紫色 #AF52DE)
   - 价值层5个(绿色 #34C759)

5. **DeepSeek AI集成**
   - 主调用模型 + 三重容错(DeepSeek→Qwen→OpenAI)
   - 目标: 10轮辩论 < 5000 tokens

### **2.2 已知问题(P0需修复)**

**🔴 优先级P0(阻碍演示):**
- **#018**: UI按钮Bug - "完成"按钮只消失未触发逻辑
- **#059**: DeepSeek API超时无处理机制
- **#008**: 领袖总结不完整(50% COMPLETE,待完成lines 1468-1477)

**🟡 优先级P1(影响体验):**
- **#014**: 委托人实时发言功能缺失
- **#057**: 角色数少于8个时无自动补足

### **2.3 技术债务**

1. **代码注释不足** (debateEngine.js > 1600行,注释率<30%)
2. **测试覆盖率为0** (无单元测试,无E2E测试)
3. **错误处理不完善** (多处catch块仅console.log)
4. **LocalStorage依赖过重** (无后端持久化)

---

## **3. 三阶段交付计划**

### **🎯 阶段一: Lite基本功能版**

**目标**: 1周内(5个工作日)可演示3-5轮完整辩论

**必须完成(P0 - 工作量24分):**

| 任务ID | 任务名称 | 工作量 | 优先级 | 文件位置 |
|--------|---------|--------|--------|----------|
| #018 | UI按钮Bug修复 | 2分 | P0 | duomotai/index.html lines 1063-1067 |
| #059 | DeepSeek超时处理 | 3分 | P0 | server/services/aiService.js |
| #008 | 领袖总结完整性 | 3分 | P0 | debateEngine.js lines 1468-1477 |
| #014 | 委托人实时发言 | 4分 | P0 | debateEngine.js + index.html |
| #083 | 测试v8完整流程 | 5分 | P0 | 3个场景验证 |
| #057 | 角色自动补足 | 3分 | P0 | index.html (准备阶段) |
| #035 | 3轮辩论测试 | 2分 | P1 | 验证流程 |
| #084 | 数据引用率验证 | 2分 | P1 | 统计专家发言质量 |

**里程碑交付物:**
- ✅ 可演示的3轮完整辩论视频录屏(>3分钟)
- ✅ 测试报告(至少3个场景: RRXS自媒体/电商创业/个人成长)
- ✅ Bug修复确认清单
- ✅ 备份: `rrxsxyz_next_<YYYYMMDDHHmm>_Stage1_Lite_Delivered.zip`

**验收标准:**
- [ ] 所有P0 Bug已修复
- [ ] 可演示3轮辩论无崩溃
- [ ] 测试报告完成
- [ ] Git状态清洁(untracked < 5个)

**预计完成时间**: 2025-10-16 (1周后)

---

### **🎨 阶段二: 前台优化全功能版**

**目标**: 2周内(10个工作日)界面美观,支持个性化

**必须完成(P0 - 工作量22分):**

| 任务ID | 任务名称 | 工作量 | 优先级 | 说明 |
|--------|---------|--------|--------|------|
| #016 | 按钮文本更新 | 1分 | P0 | "确认,继续"文案优化 |
| #017 | 快捷键Ctrl+Enter | 2分 | P0 | 绑定+UI标注 |
| #042 | userProfile检查集成 | 3分 | P0 | 主页加载时检查用户信息 |
| #043 | AI提示词集成画像 | 4分 | P0 | buildRoleSpeechPrompt融入用户画像 |
| #044 | 后端API实现 | 5分 | P0 | 3个用户相关API |
| #045 | 测试v5完整流程 | 3分 | P0 | 验证个性化功能 |
| #065 | 角色hover效果 | 2分 | P1 | 显示intro字段 |
| #085 | UI显示优化 | 3分 | P1 | 大字体16px+清晰度 |
| #093 | markdownToHTML应用 | 2分 | P1 | 专家发言格式化 |
| #094 | 发言格式优化 | 2分 | P1 | 重点词加粗+分行 |

**可选(Nice to have - 工作量6分):**
- #013 流式输出SSE (提升体验但非必需)

**里程碑交付物:**
- ✅ 美观的UI演示(截图集+录屏)
- ✅ 个性化辩论示例(不同用户画像对比)
- ✅ 用户测试反馈报告(至少5个真实用户)
- ✅ 备份: `rrxsxyz_next_<YYYYMMDDHHmm>_Stage2_UI_Delivered.zip`

**验收标准:**
- [ ] 界面美观(用户测试评分>8/10)
- [ ] 个性化功能可用
- [ ] 快捷键生效
- [ ] 至少5个用户测试反馈

**预计完成时间**: 2025-10-30 (阶段1后2周)

---

### **🧠 阶段三: 后台优化高级智能版**

**目标**: 1个月内AI智能化,长对话支持

**必须完成(P0 - 工作量21分):**

| 任务ID | 任务名称 | 工作量 | 优先级 | 新增文件 |
|--------|---------|--------|--------|----------|
| T-301 | ContextDatabase MVP | 6分 | P0 | src/modules/contextDatabase.js |
| T-302 | summaryEngine | 6分 | P0 | src/modules/summaryEngine.js |
| T-303 | Prompt-Agent模板库 | 5分 | P0 | src/modules/promptAgent.js |
| T-304 | dataValidator | 4分 | P0 | src/modules/dataValidator.js |

**应该完成(P1 - 工作量15分):**
- #010 长上下文模型评估 (4分)
- #009 动态轮次主题 (4分)
- T-305 可视化争议热力图 (7分, 使用ECharts)

**可选(研究性 - 工作量19分):**
- #086 v8.2语音交互集成 (8分)
- #087 v8.3预调研资料整合 (6分)
- #076 辩论后模型迭代 (5分)

**里程碑交付物:**
- ✅ 10轮+长对话测试报告
- ✅ 争议热力图演示
- ✅ Prompt-Agent模板库文档
- ✅ 性能基准测试(token消耗/响应时间)
- ✅ 备份: `rrxsxyz_next_<YYYYMMDDHHmm>_Stage3_AI_Delivered.zip`

**验收标准:**
- [ ] 10轮对话无性能问题
- [ ] 争议热力图可视化展示
- [ ] Token消耗<5000/10轮
- [ ] 响应时间P95<5秒

**预计完成时间**: 2025-11-30 (阶段2后1个月)

---

### **3.4 时间线总览**

```
2025-10-09(今天) → 2025-10-16 → 2025-10-30 → 2025-11-30
     现状v8      →  阶段1完成  →  阶段2完成  →  阶段3完成
                   Lite版       UI优化版       AI智能版
                   (可演示)     (可上线)       (可推广)
```

**总计工作量估算:**
- 阶段1: 24分 ≈ 24小时 ≈ 3-4个工作日
- 阶段2: 33分 ≈ 33小时 ≈ 5-7个工作日
- 阶段3: 55分 ≈ 55小时 ≈ 8-10个工作日
- **总计: 112分 ≈ 112小时 ≈ 15-20个工作日 (3-4周)**

---

## **4. 架构设计**

### **4.1 核心模块分层**

```
┌─────────────────────────────────────────────┐
│          用户交互层 (User Interface)         │
│  ┌───────────────────────────────────────┐  │
│  │   index.html (主界面)                  │  │
│  │   - 角色选择卡片 (16个)                │  │
│  │   - 准备阶段表单                       │  │
│  │   - 辩论展示区                         │  │
│  │   - 委托人互动按钮                     │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                     ↓ ↑
┌─────────────────────────────────────────────┐
│         业务逻辑层 (Business Logic)          │
│  ┌───────────────────────────────────────┐  │
│  │   debateEngine.js (辩论引擎核心)      │  │
│  │   - runRound() 单轮辩论执行           │  │
│  │   - buildRoleSpeechPrompt() 提示词   │  │
│  │   - ContextDatabase 对话信息数据库    │  │
│  │   - 5阶段流程控制                     │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │   roles.js (角色配置)                 │  │
│  │   - 16角色定义                        │  │
│  │   - systemPrompt + 建议要求           │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                     ↓ ↑
┌─────────────────────────────────────────────┐
│           AI服务层 (AI Services)             │
│  ┌───────────────────────────────────────┐  │
│  │   aiService.js (AI调用)               │  │
│  │   - DeepSeek API (主)                 │  │
│  │   - Qwen API (备1)                    │  │
│  │   - OpenAI API (备2)                  │  │
│  │   - 三重容错机制                      │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                     ↓ ↑
┌─────────────────────────────────────────────┐
│          数据持久层 (Data Layer)             │
│  ┌───────────────────────────────────────┐  │
│  │   LocalStorage (前端缓存)             │  │
│  │   - 发言记录                          │  │
│  │   - 用户画像                          │  │
│  │   - 辩论状态                          │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │   server/data/ (后端JSON文件)         │  │
│  │   - 用户信息                          │  │
│  │   - 辩论历史                          │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### **4.2 阶段三新增模块(v11扩展)**

```
业务逻辑层扩展:
┌─────────────────────────────────────────────┐
│  新增模块 (阶段3)                             │
│  ┌───────────────────────────────────────┐  │
│  │   contextDatabase.js                  │  │
│  │   - speeches[] 所有发言记录            │  │
│  │   - keyPoints Map 关键观点索引         │  │
│  │   - controversies[] 争议焦点           │  │
│  │   - getRelevantContext() 三层上下文   │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │   summaryEngine.js                    │  │
│  │   - 自动摘要每轮要点(120-180字)        │  │
│  │   - 智能裁剪上下文                    │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │   promptAgent.js                      │  │
│  │   - 提示词模板库                      │  │
│  │   - 版本控制                          │  │
│  │   - generate(templateId, params)      │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │   dataValidator.js                    │  │
│  │   - 数据引用校验                      │  │
│  │   - 来源标注                          │  │
│  │   - 无来源标记"需要验证"              │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

---

## **5. 关键技术决策**

### **5.1 已确定的技术栈**

**前端:**
- Vanilla JS (无React/Vue框架,降低复杂度)
- TailwindCSS (实用工具类CSS)
- Material Design动画 (卡片交互)

**后端:**
- Node.js 18+ + Express
- JSON文件存储 (阶段1-2)
- LocalStorage + SessionStorage (前端缓存)

**AI服务:**
- DeepSeek API (主,免费额度)
- Qwen API (备1)
- OpenAI API (备2)

### **5.2 简化的设计决策(相比v10)**

**❌ 不做(过度设计):**
- Redis分布式锁 → 单进程文件锁已足够
- ContextDatabase复杂索引 → 简单数组+Map足够(< 1000条记录)
- 微服务架构 → 单体应用更简单
- GraphQL → REST API足够
- 多语言国际化 → 仅支持中文(阶段1-3)

**✅ 优先(实用主义):**
- 原子写入(temp→rename) → 保留,但去除文件锁
- 三重容错AI调用 → 保留,提升可靠性
- LocalStorage优先 → 快速验证,阶段3可迁移到数据库
- 单文件HTML → 简化部署

### **5.3 关键算法说明**

**ContextDatabase三层上下文:**
```javascript
getRelevantContext(roleId, currentRound) {
  return {
    myHistory: this.keyPoints.get(roleId).slice(-3), // 最近3次自己的发言
    othersKeyPoints: this.extractOthersKeyPoints(roleId, currentRound, 5), // 其他专家最近5轮的关键观点
    allRounds: this.getRoundSummaries() // 所有轮次的摘要
  };
}
```

**summaryEngine裁剪规则:**
```javascript
summarizeRound(roundData) {
  // 目标: 120-180字摘要
  // 优先保留: 数据引用 > 关键建议 > 争议点
  // 合并重复观点并计数
}
```

---

## **6. 风险与应对**

### **6.1 技术风险**

**🚨 风险1: AI API限流/超时**
- **概率**: 中
- **影响**: 高(阻碍演示)
- **应对**:
  - 阶段1必须完成#059超时处理
  - 保留三重容错机制
  - 添加重试机制(最多3次,间隔2秒)

**🚨 风险2: LocalStorage数据丢失**
- **概率**: 低
- **影响**: 中(用户数据丢失)
- **应对**:
  - 每轮结束后自动备份到后端
  - 阶段3迁移到数据库
  - 提示用户关键时刻不要清除浏览器缓存

**🚨 风险3: 长对话Token超限**
- **概率**: 中
- **影响**: 中(阶段3影响)
- **应对**:
  - 实现summaryEngine智能裁剪
  - 设定轮数上限(10轮)
  - 监控Token消耗,超过4000提示用户

### **6.2 项目管理风险**

**🚨 风险4: 范围蔓延**
- **表现**: 总想加新功能,阶段1还没完就想做阶段3
- **应对**:
  - 严格按阶段执行,每阶段结束前不开始下一阶段
  - 用backup作为阶段分界线
  - 新想法记录到ideas.md,阶段完成后评估

**🚨 风险5: 完美主义陷阱**
- **表现**: UI调整无止境
- **应对**:
  - 设定"足够好"标准
  - 用户测试驱动优化
  - 记住: 80%质量上线,收集反馈再迭代

---

## **7. 验收标准**

### **7.1 阶段1验收清单**

- [ ] **功能验收**:
  - [ ] 可演示3轮完整辩论(视频>3分钟)
  - [ ] 所有P0 Bug已修复(#018, #059, #008, #014)
  - [ ] 委托人可在3个节点实时发言
  - [ ] 少于8个角色时自动补足

- [ ] **质量验收**:
  - [ ] 无明显崩溃或卡死
  - [ ] 错误有友好提示(不是console.log)
  - [ ] 数据引用率>60%(至少10/16专家发言包含数据)

- [ ] **文档验收**:
  - [ ] 测试报告完成(3个场景)
  - [ ] progress.md与代码状态一致
  - [ ] Git状态清洁(untracked < 5个)

- [ ] **备份验收**:
  - [ ] 执行>>zip生成备份
  - [ ] 备份文件命名正确: `rrxsxyz_next_<YYYYMMDDHHmm>_Stage1_Lite_Delivered.zip`
  - [ ] 备份大小合理(< 50MB,排除logs和node_modules)

### **7.2 阶段2验收清单**

- [ ] **功能验收**:
  - [ ] 用户画像调研弹窗可用
  - [ ] AI输出包含个性化内容
  - [ ] 快捷键Ctrl+Enter生效
  - [ ] 界面美观(符合Apple风格)

- [ ] **用户验收**:
  - [ ] 至少5个真实用户测试
  - [ ] 用户满意度评分>8/10
  - [ ] 收集到改进建议列表

- [ ] **性能验收**:
  - [ ] 首屏加载时间<2秒
  - [ ] 单轮辩论响应时间<8秒
  - [ ] 无明显卡顿或延迟

### **7.3 阶段3验收清单**

- [ ] **智能化验收**:
  - [ ] 10轮长对话无性能问题
  - [ ] Token消耗<5000/10轮
  - [ ] 上下文裁剪正常工作

- [ ] **可视化验收**:
  - [ ] 争议热力图可正常展示
  - [ ] hover显示关键发言链接
  - [ ] 颜色编码清晰(争议强度)

- [ ] **稳定性验收**:
  - [ ] 响应时间P95<5秒
  - [ ] 错误率<1%(100次调用<1次失败)
  - [ ] 3个场景各测试5次,全部通过

### **7.4 最终交付验收**

- [ ] **所有3阶段验收通过**
- [ ] **用户手册完成**(至少包含: 快速开始/常见问题/高级功能)
- [ ] **开发者文档完成**(API文档/架构说明/部署指南)
- [ ] **演示视频**(5-10分钟,展示完整流程)
- [ ] **产品宣传页**(落地页,包含功能介绍/用户评价/CTA)
- [ ] **真实用户反馈>20个**(问卷或访谈)

---

## **8. 附录**

### **8.1 关键文件路径清单**

**核心业务代码:**
```
duomotai/
├── index.html                          # 主界面
├── src/
│   ├── config/
│   │   └── roles.js                    # 16角色配置
│   └── modules/
│       ├── debateEngine.js             # 辩论引擎核心(1600+行)
│       ├── contextDatabase.js          # 对话信息数据库(阶段3新增)
│       ├── summaryEngine.js            # 摘要引擎(阶段3新增)
│       ├── promptAgent.js              # 提示词模板库(阶段3新增)
│       └── dataValidator.js            # 数据校验(阶段3新增)
```

**后端服务:**
```
server/
├── server.js                           # Express主服务器
├── services/
│   ├── aiService.js                    # AI模型调用
│   ├── emailService.js                 # 邮件服务
│   └── userDataService.js              # 用户数据管理
└── .env                                # 环境配置(需手动创建)
```

**项目管理:**
```
/
├── CLAUDE.md                           # CCR核心工作指导
├── progress.md                         # 项目记忆文件
├── .claude/
│   ├── agents/
│   │   └── progress-recorder.md        # 记录员配置
│   ├── backups/                        # 备份目录
│   ├── snapshots/                      # 快照目录
│   └── audit.log                       # 审计日志
└── scripts/
    └── TaskDone_BackUp_Exclude.ps1     # 备份脚本
```

### **8.2 常用命令速查**

**开发服务器:**
```bash
# 前端(端口8080)
python -m http.server 8080

# 后端(端口3000)
cd server && npm run dev
```

**项目记忆管理:**
```bash
# 在Claude Code对话中使用:
>>record              # 增量记录进度
>>wrap-up             # 会话收尾
>>zip                 # 创建备份
```

**测试:**
```bash
# 邮件服务测试
cd server && node test-email.js

# 健康检查
curl http://localhost:3000/health
```

**备份(手动):**
```powershell
# 执行备份(排除logs和node_modules)
powershell -NoProfile -ExecutionPolicy Bypass -File "scripts/TaskDone_BackUp_Exclude.ps1" -Keyword "Stage1_Lite" -TaskId "083" -Execute
```

### **8.3 技术选型理由**

**为什么用Vanilla JS而不是React?**
- 避免打包工具复杂度(Webpack/Vite配置)
- 减少依赖和版本冲突
- 单文件HTML便于快速部署
- 团队(单人)熟悉度高

**为什么用LocalStorage而不是数据库?**
- 阶段1-2快速验证,无需后端复杂度
- 前端响应速度快(无网络往返)
- 阶段3可迁移到MongoDB/PostgreSQL
- 用户数据量小(< 100KB/用户)

**为什么用JSON文件而不是数据库?**
- 开发环境简单,无需安装MySQL/MongoDB
- 易于备份和版本控制(Git)
- 阶段1-2用户量小(< 100个)
- 阶段3可迁移

---

## **9. 下一步行动(立即执行)**

**✅ 今天(2025-10-09)完成:**
1. [ ] 阅读并确认本架构文档
2. [ ] 执行>>zip备份当前状态(关键字: Pre_Stage1_Baseline)
3. [ ] 更新progress.md,添加阶段1的8个任务
4. [ ] 开始修复#018 UI按钮Bug(预计2小时)

**✅ 本周(2025-10-09 ~ 2025-10-13)完成:**
- [ ] 完成阶段1所有P0任务(#018, #059, #008, #014, #083, #057)
- [ ] 执行3个场景测试,生成测试报告
- [ ] 周五下午验收阶段1,创建备份

**✅ 下周(2025-10-14 ~ 2025-10-20)完成:**
- [ ] 开始阶段2 UI优化任务
- [ ] 实现用户画像调研功能
- [ ] 邀请5个用户测试

---

**文档维护:**
- **创建**: 2025-10-09
- **最后更新**: 2025-10-09 05:00 (GMT+8)
- **下次审查**: 阶段1完成时(预计 2025-10-16)

**版本历史:**
- v11.0 Executable - 初始版本,基于v8现状和v10规划整合
- v10.0 - 理论化版本(已归档)
- v8.0 - 当前运行版本

---

**📌 记住第一纲领: 项目高效早日完成 > 追求完美**

迭代比完美更重要。先交付,再优化。
