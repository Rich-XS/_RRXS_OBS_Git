# 聊天记录自动保存系统

## 系统架构

### 核心组件
1. **记录收集器**：捕获各平台对话
2. **数据处理器**：格式化和分类
3. **存储引擎**：本地 + 云端备份
4. **检索系统**：RAG 集成

## 实施方案

### 方案1：浏览器扩展 + 本地存储

#### 1.1 Chrome 扩展开发
```javascript
// manifest.json
{
  "manifest_version": 3,
  "name": "RRXS Chat Saver",
  "version": "1.0",
  "permissions": ["storage", "activeTab"],
  "content_scripts": [{
    "matches": ["*://chat.openai.com/*", "*://claude.ai/*", "*://gemini.google.com/*"],
    "js": ["content.js"]
  }]
}

// content.js - 聊天记录捕获
function saveChatHistory() {
  const chatElements = document.querySelectorAll('[data-message-id], .message, .conversation-turn');
  const chatData = [];
  
  chatElements.forEach(el => {
    chatData.push({
      timestamp: new Date().toISOString(),
      platform: window.location.hostname,
      role: el.classList.contains('user') ? 'user' : 'assistant',
      content: el.textContent.trim(),
      messageId: el.getAttribute('data-message-id') || generateId()
    });
  });
  
  // 保存到本地存储
  chrome.storage.local.set({
    [`chat_${Date.now()}`]: {
      url: window.location.href,
      title: document.title,
      timestamp: new Date().toISOString(),
      messages: chatData
    }
  });
}

// 每30秒自动保存
setInterval(saveChatHistory, 30000);
```

#### 1.2 数据导出到 Obsidian
```javascript
// 导出为 Markdown 格式
function exportToObsidian(chatData) {
  const markdown = `# ${chatData.title}

**平台**: ${chatData.platform}
**时间**: ${chatData.timestamp}
**链接**: ${chatData.url}

## 对话内容

${chatData.messages.map(msg => 
  `### ${msg.role === 'user' ? '🙋‍♂️ 用户' : '🤖 AI助手'}
${msg.content}

*时间: ${msg.timestamp}*

---
`).join('\n')}

## 标签
#聊天记录 #AI对话 #${new Date().toISOString().split('T')[0]}
`;

  // 保存到指定目录
  const fileName = `对话记录_${chatData.platform}_${Date.now()}.md`;
  downloadFile(fileName, markdown);
}
```

### 方案2：集成到现有 rrxsxyz_next 系统

#### 2.1 扩展后端服务
```javascript
// server/services/chatHistoryService.js
const fs = require('fs').promises;
const path = require('path');

class ChatHistoryService {
  constructor() {
    this.historyDir = path.join(__dirname, '../data/chat-history');
    this.ensureDirectoryExists();
  }

  async ensureDirectoryExists() {
    try {
      await fs.access(this.historyDir);
    } catch {
      await fs.mkdir(this.historyDir, { recursive: true });
    }
  }

  async saveChatSession(sessionData) {
    const fileName = `chat_${sessionData.platform}_${Date.now()}.json`;
    const filePath = path.join(this.historyDir, fileName);
    
    const chatRecord = {
      id: sessionData.id || this.generateId(),
      platform: sessionData.platform,
      title: sessionData.title,
      timestamp: new Date().toISOString(),
      messages: sessionData.messages,
      metadata: {
        userAgent: sessionData.userAgent,
        url: sessionData.url,
        tags: this.extractTags(sessionData.messages)
      }
    };

    await fs.writeFile(filePath, JSON.stringify(chatRecord, null, 2));
    
    // 同时保存为 Markdown
    await this.saveAsMarkdown(chatRecord);
    
    return chatRecord.id;
  }

  async saveAsMarkdown(chatRecord) {
    const markdown = this.generateMarkdown(chatRecord);
    const fileName = `${chatRecord.id}.md`;
    const mdPath = path.join(this.historyDir, 'markdown', fileName);
    
    await fs.mkdir(path.dirname(mdPath), { recursive: true });
    await fs.writeFile(mdPath, markdown);
  }

  generateMarkdown(chatRecord) {
    return `# ${chatRecord.title}

**ID**: ${chatRecord.id}
**平台**: ${chatRecord.platform}
**时间**: ${chatRecord.timestamp}
**URL**: ${chatRecord.metadata.url}

## 对话记录

${chatRecord.messages.map((msg, index) => `
### 第${index + 1}轮对话

**${msg.role === 'user' ? '👤 用户' : '🤖 AI'}**: 
${msg.content}

*时间: ${msg.timestamp}*
`).join('\n')}

## 标签
${chatRecord.metadata.tags.map(tag => `#${tag}`).join(' ')}

---
*自动生成于: ${new Date().toISOString()}*
`;
  }

  extractTags(messages) {
    const allText = messages.map(m => m.content).join(' ');
    const keywords = ['AI', '编程', '项目', '策略', '分析', '优化'];
    return keywords.filter(keyword => 
      allText.toLowerCase().includes(keyword.toLowerCase())
    );
  }

  generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
}

module.exports = ChatHistoryService;
```

#### 2.2 添加 API 接口
```javascript
// server/server.js 中添加
const ChatHistoryService = require('./services/chatHistoryService');
const chatHistory = new ChatHistoryService();

// 保存聊天记录的 API
app.post('/api/chat-history', async (req, res) => {
  try {
    const sessionId = await chatHistory.saveChatSession(req.body);
    res.json({ success: true, sessionId });
  } catch (error) {
    console.error('保存聊天记录失败:', error);
    res.status(500).json({ error: '保存失败' });
  }
});

// 获取聊天记录列表
app.get('/api/chat-history', async (req, res) => {
  try {
    const history = await chatHistory.getHistoryList();
    res.json(history);
  } catch (error) {
    res.status(500).json({ error: '获取记录失败' });
  }
});
```

### 方案3：Python 自动化脚本

#### 3.1 全平台监控脚本
```python
# chat_monitor.py
import time
import json
import os
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By
import schedule

class ChatHistoryMonitor:
    def __init__(self):
        self.save_dir = r"d:\OneDrive_RRXS\OneDrive\_RRXS_OBS\_RRXS\千锤百问IP项目\07-资源库\对话记录"
        self.ensure_directory()
        
    def ensure_directory(self):
        os.makedirs(self.save_dir, exist_ok=True)
        
    def save_chatgpt_history(self):
        """保存 ChatGPT 对话记录"""
        driver = webdriver.Chrome()
        try:
            driver.get("https://chat.openai.com")
            time.sleep(5)
            
            # 获取对话历史
            conversations = driver.find_elements(By.CSS_SELECTOR, "[data-testid='conversation-turn']")
            
            chat_data = []
            for conv in conversations:
                chat_data.append({
                    "timestamp": datetime.now().isoformat(),
                    "platform": "ChatGPT",
                    "content": conv.text,
                    "type": "conversation"
                })
            
            # 保存为 JSON
            filename = f"chatgpt_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            filepath = os.path.join(self.save_dir, filename)
            
            with open(filepath, 'w', encoding='utf-8') as f:
                json.dump(chat_data, f, ensure_ascii=False, indent=2)
                
            # 保存为 Markdown
            self.save_as_markdown(chat_data, "ChatGPT")
            
        finally:
            driver.quit()
    
    def save_as_markdown(self, chat_data, platform):
        """转换为 Markdown 格式"""
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        markdown_content = f"""# {platform} 对话记录

**时间**: {timestamp}
**平台**: {platform}

## 对话内容

"""
        
        for i, item in enumerate(chat_data, 1):
            markdown_content += f"""### 对话 {i}

{item['content']}

---

"""
        
        markdown_content += f"""
## 元数据
- 导出时间: {timestamp}
- 记录数量: {len(chat_data)}
- 平台: {platform}

#聊天记录 #{platform} #自动备份
"""
        
        filename = f"{platform}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        filepath = os.path.join(self.save_dir, filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(markdown_content)

    def schedule_backups(self):
        """定时备份"""
        # 每小时备份一次
        schedule.every().hour.do(self.save_chatgpt_history)
        
        while True:
            schedule.run_pending()
            time.sleep(60)

if __name__ == "__main__":
    monitor = ChatHistoryMonitor()
    monitor.schedule_backups()
```

## 自动化部署

### 1. Windows 任务计划程序
```batch
REM backup_chats.bat
@echo off
cd /d "d:\OneDrive_RRXS\OneDrive\_RRXS_OBS\_RRXS\千锤百问IP项目\07-资源库"
python chat_monitor.py
```

### 2. 集成到现有启动脚本
```batch
REM 修改 启动本地服务器.bat
@echo off
echo 启动服务器和聊天记录监控...

REM 启动网站服务器
start "Web Server" cmd /k "cd /d d:\OneDrive_RRXS\OneDrive\_AIGPT\VSCode\100W\rrxsxyz_next\server && npm start"

REM 启动聊天记录监控
start "Chat Monitor" cmd /k "cd /d d:\OneDrive_RRXS\OneDrive\_RRXS_OBS\_RRXS\千锤百问IP项目\07-资源库 && python chat_monitor.py"

echo 所有服务已启动
pause
```

## 数据管理与检索

### 1. 集成到 RAG 系统
```python
# rag_chat_integration.py
from langchain_community.vectorstores import Chroma
from langchain_community.embeddings import OpenAIEmbeddings
import json
import os

class ChatHistoryRAG:
    def __init__(self):
        self.chat_dir = r"d:\OneDrive_RRXS\OneDrive\_RRXS_OBS\_RRXS\千锤百问IP项目\07-资源库\对话记录"
        self.vectorstore = None
        self.setup_vectorstore()
    
    def setup_vectorstore(self):
        """设置向量存储"""
        embeddings = OpenAIEmbeddings()
        self.vectorstore = Chroma(
            persist_directory="./chat_history_db",
            embedding_function=embeddings
        )
    
    def index_chat_history(self):
        """索引所有聊天记录"""
        for filename in os.listdir(self.chat_dir):
            if filename.endswith('.json'):
                filepath = os.path.join(self.chat_dir, filename)
                with open(filepath, 'r', encoding='utf-8') as f:
                    chat_data = json.load(f)
                
                # 为每条对话创建文档
                for item in chat_data:
                    self.vectorstore.add_texts(
                        texts=[item['content']],
                        metadatas=[{
                            'platform': item['platform'],
                            'timestamp': item['timestamp'],
                            'filename': filename
                        }]
                    )
    
    def search_chat_history(self, query, k=5):
        """搜索聊天记录"""
        results = self.vectorstore.similarity_search(query, k=k)
        return results
```

## 维护与监控

### 1. 定期清理脚本
```python
# cleanup_old_chats.py
import os
import time
from datetime import datetime, timedelta

def cleanup_old_files(directory, days=30):
    """删除超过指定天数的文件"""
    cutoff_time = time.time() - (days * 24 * 60 * 60)
    
    for filename in os.listdir(directory):
        filepath = os.path.join(directory, filename)
        if os.path.getctime(filepath) < cutoff_time:
            os.remove(filepath)
            print(f"已删除过期文件: {filename}")
```

### 2. 备份状态监控
```python
# backup_monitor.py
import smtplib
from email.mime.text import MimeText
import json
from datetime import datetime

def send_backup_report():
    """发送备份状态报告"""
    # 统计今日备份文件数量
    # 发送邮件通知
    pass
```

## 使用建议

1. **立即启用方案2**：集成到现有 rrxsxyz_next 系统
2. **定期检查**：每周检查备份文件完整性
3. **标签管理**：为重要对话添加自定义标签
4. **隐私保护**：敏感对话内容加密存储
5. **跨平台同步**：利用 OneDrive 实现多设备访问

## 预期效果

- ✅ 100% 自动化聊天记录保存
- ✅ 多格式支持（JSON、Markdown）
- ✅ RAG 系统集成，支持语义搜索
- ✅ 与现有知识管理系统无缝集成
- ✅ 跨平台备份（OneDrive 自动同步）

---

*创建时间: 2025-09-30*
*更新周期: 根据使用情况调整*